'use client';

import { useState } from 'react';
import Link from 'next/link';
import dynamic from 'next/dynamic';
import { Search, MapPin, Check } from 'lucide-react';

import { SERVICE_POLYGON } from '@/components/ServiceAreaMap';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/input';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

// Lazy-loaded map
const ServiceAreaMap = dynamic(() => import('@/components/ServiceAreaMap'), {
  ssr: false,
  loading: () => <div className="h-[500px] w-full bg-gray-100 animate-pulse" />
});

// Point-in-polygon check
function pointInPolygon([lat, lon]: [number, number], poly: [number, number][]) {
  const x = lon, y = lat; // Note: Leaflet uses [lat, lng] but pointInPolygon uses [lng, lat]
  let inside = false;
  for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
    const [yi, xi] = poly[i];
    const [yj, xj] = poly[j];
    const intersect = yi > y !== yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
    if (intersect) inside = !inside;
  }
  return inside;
}

export default function ServiceAreaContent() {
  const [query, setQuery] = useState('');
  const [status, setStatus] = useState<'idle' | 'loading' | 'done'>('idle');
  const [inside, setInside] = useState<boolean | null>(null);
  const [address, setAddress] = useState('');
  const [error, setError] = useState('');

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!query.trim()) return;

    setStatus('loading');
    setError('');
    
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`
      );
      if (!res.ok) throw new Error('Failed to fetch location');
      
      const data = await res.json();
      if (!data.length) throw new Error('Location not found. Please try a different address.');

      const { lat, lon, display_name } = data[0];
      const inArea = pointInPolygon([parseFloat(lat), parseFloat(lon)], SERVICE_POLYGON);

      setAddress(display_name);
      setInside(inArea);
      setStatus('done');
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred while searching');
      setStatus('idle');
    }
  }

  return (
    <div className="container mx-auto px-4 py-12">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold text-center mb-8">Our Service Area</h1>
        
        <div className="grid md:grid-cols-2 gap-8 mb-12">
          <div>
            <h2 className="text-2xl font-semibold mb-4">Check Your Location</h2>
            <p className="text-gray-600 mb-6">
              Enter your address below to see if we service your area. We proudly serve Central Alberta 
              and surrounding regions with our professional gutter services.
            </p>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Search className="h-5 w-5 text-gray-400" />
                </div>
                <Input
                  type="text"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="Enter your address"
                  className="pl-10 w-full"
                  disabled={status === 'loading'}
                />
              </div>
              <Button 
                type="submit" 
                className="w-full md:w-auto"
                disabled={status === 'loading'}
              >
                {status === 'loading' ? 'Checking...' : 'Check Availability'}
              </Button>
            </form>

            {error && (
              <div className="mt-4 p-4 bg-red-50 text-red-700 rounded-md">
                {error}
              </div>
            )}

            {status === 'done' && (
              <Card className="mt-6">
                <CardHeader>
                  <div className="flex items-center">
                    <div className={`p-2 rounded-full ${inside ? 'bg-green-100' : 'bg-blue-100'} mr-3`}>
                      <Check className={`h-6 w-6 ${inside ? 'text-green-600' : 'text-blue-600'}`} />
                    </div>
                    <CardTitle>
                      {inside ? 'We Service Your Area!' : 'Service Not Available'}
                    </CardTitle>
                  </div>
                </CardHeader>
                <CardContent>
                  <p className="text-gray-600 mb-4">
                    {inside ? (
                      'Great news! We provide our services at this location.'
                    ) : (
                      'We currently do not service this area, but we may be able to make exceptions. Please contact us to discuss your needs.'
                    )}
                  </p>
                  <div className="flex flex-col sm:flex-row gap-4 mt-4">
                    <Button asChild variant={inside ? 'default' : 'outline'}>
                      <Link href="/contact">
                        {inside ? 'Get a Free Estimate' : 'Contact Us'}
                      </Link>
                    </Button>
                    <Button variant="outline" asChild>
                      <a href="tel:+14035222422">
                        <MapPin className="mr-2 h-4 w-4" />
                        (403) 522-2422
                      </a>
                    </Button>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
          
          <div className="h-[500px] rounded-lg overflow-hidden border border-gray-200">
            <ServiceAreaMap />
          </div>
        </div>

        <div className="bg-blue-50 p-6 rounded-lg">
          <h2 className="text-2xl font-semibold mb-4">Our Service Coverage</h2>
          <p className="mb-4">
            We proudly serve Central Alberta including but not limited to:
          </p>
          <div className="grid md:grid-cols-2 gap-4">
            <ul className="space-y-2">
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Red Deer
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Blackfalds
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Lacombe
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Ponoka
              </li>
            </ul>
            <ul className="space-y-2">
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Innisfail
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Sylvan Lake
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                Bentley
              </li>
              <li className="flex items-center">
                <Check className="h-5 w-5 text-green-600 mr-2" />
                And surrounding areas
              </li>
            </ul>
          </div>
          
          <div className="mt-6">
            <p className="text-sm text-gray-600">
              Don't see your location listed? Contact us to check if we can accommodate your needs.
              We're always expanding our service area to better serve our customers.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
